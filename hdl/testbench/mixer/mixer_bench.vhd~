-------------------------------------------------------------------------------
-- Title      : Mixer testbench
-- Project    : 
-------------------------------------------------------------------------------
-- File       : mixer_bench.vhd
-- Author     : Gustavo BM Bruno
-- Company    : LNLS
-- Created    : 2014-01-21
-- Last update: 2014-01-22
-- Platform   : 
-- Standard   : VHDL'93/02
-------------------------------------------------------------------------------
-- Description: Tests the mixer stage of the BPM DSP chain.
-------------------------------------------------------------------------------
-- Copyright (c) 2014 
-------------------------------------------------------------------------------
-- Revisions  :
-- Date        Version  Author  Description
-- 2014-01-21  1.0      aylons  Created
-------------------------------------------------------------------------------

library ieee;
use ieee.std_logic_1164.all;
use ieee.numeric_std.all;

library std;
use std.textio.all;

library UNISIM;
use UNISIM.vcomponents.all;

entity mixer_bench is
end mixer_bench;

architecture test of mixer_bench is

  signal clock     : std_logic := '0';
  signal adc_data  : std_logic_vector(31 downto 0);
  signal endoffile : bit := '0';
  
  component mixer is
    port(
      rst     : in  std_logic;
      clk_adc : in  std_logic;
      input   : in  std_logic_vector(31 downto 0);
      I_out   : out std_logic_vector(31 downto 0);
      Q_out   : out std_logic_vector(31 downto 0));
  end component;
  
begin

  clk_gen : process
  begin
    clock <= '0';
    wait for 7.69 ns;
    clock <= '1';
    wait for 7.69 ns;
  end process;

  adc_read : process(clock)
    file adc_file     : text open read_mode is "adc_data.dat";
    variable cur_line : line;
    variable datain   : real;
  begin
    if rising_edge(clock) then
      if not endfile(adc_file) then
        readline(adc_file, cur_line);
        read(cur_line, datain);
        read(cur_line, datain);
        adc_data <= std_logic_vector(to_signed(integer(datain),32));
      else
        endoffile <= '1';
      end if;
    end if;
  end process adc_read;

  signal_write : process(clock)
    file mixer_file   : text open write_mode is "mixer_out.dat";
    variable cur_line : line;
    variable dataout  : integer;
  begin
    if(endoffile = '0') then
      dataout := to_integer(signed(adc_data));
      write(cur_line, dataout);
      writeline(mixer_file, cur_line);
    else
      null;
    end if;
  end process;
  
end test;
