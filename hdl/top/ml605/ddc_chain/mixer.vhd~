-------------------------------------------------------------------------------
-- Title      : BPM Mixer
-- Project    : 
-------------------------------------------------------------------------------
-- File       : mixer.vhd
-- Author     : Gustavo BM Bruno
-- Company    : LNLS - CNPEM
-- Created    : 2014-01-21
-- Last update: 2014-01-22
-- Platform   : 
-- Standard   : VHDL'93/02
-------------------------------------------------------------------------------
-- Description: Mixer at input stage for BPM
-------------------------------------------------------------------------------
-- Copyright (c) 2014 
-------------------------------------------------------------------------------
-- Revisions  :
-- Date        Version  Author  Description
-- 2014-01-21  1.0      aylons  Created
-------------------------------------------------------------------------------

library ieee;
use ieee.std_logic_1164.all;
use ieee.numeric_std.all;

library UNISIM;
use UNISIM.vcomponents.all;

entity mixer is
  generic(
    g_center_freq : natural := 20e6;
    g_input_clk   : natural := 130e6);
  port(
    rst   : in  std_logic;
    clk   : in  std_logic;
    input : in  std_logic_vector(31 downto 0);
    I_out : out std_logic_vector(25 downto 0);
    Q_out : out std_logic_vector(25 downto 0));
end mixer;

architecture rtl of mixer is

  constant c_THETA_CARRIER : integer :=
    integer((g_center_freq*(2**20))/g_input_clock);

  constant c_THETA_VECTOR : unsigned(31 downto 0) :=
    to_unsigned(C_THETA_CARRIER, 32);

  signal sine   : std_logic_vector(31 downto 0);
  signal cosine : std_logic_vector(31 downto 0);

  signal I_temp : std_logic_vector(47 downto 0);
  signal Q_temp : std_logic_vector(47 downto 0);

  component mixer_dds
    port(
      aclk                : in  std_logic;
      s_axis_phase_tvalid : in  std_logic;
      s_axis_phase_tdata  : in  std_logic_vector(31 downto 0);
      m_axis_data_tvalid  : out std_logic;
      m_axis_data_tdata   : out std_logic_vector(63 downto 0));  -- sin/cos 26 bits,
                                        -- sign extended
                                        -- to 32
  end component;

  component multiplier_s32_s26_s24
    port (
      aclk               : in  std_logic;
      s_axis_a_tvalid    : in  std_logic;
      s_axis_a_tdata     : in  std_logic_vector(63 downto 0);
      s_axis_b_tvalid    : in  std_logic;
      s_axis_b_tdata     : in  std_logic_vector(63 downto 0);
      m_axis_dout_tvalid : out std_logic;
      m_axis_dout_tdata  : out std_logic_vector(47 downto 0)
      );
  end component;

  
begin

  cmp_mixer : mixer_dds
    port map(
      aclk                            => clk,
      s_axis_phase_tvalid             => "1",
      s_axis_phase_tdata              => c_THETA_VECTOR,
      m_axis_data_tvalid              => open,
      m_axis_data_tdata(63 downto 32) => sine,   --only 26 significant bits
      m_axis_data_tdata(31 downto 0)  => cosine  --only 26 significant bits
      );

  cmp_I_mult : multiplier_s32_s26_s24
    port map(
      aclk                         => clk,
      s_axis_a_tvalid              => "1",
      s_axis_a_tdata(63 downto 32) => (others => "0"),
      s_axis_a_tdata(31 downto 0)  => input,
      s_axis_b_tvalid              => "1",
      s_axis_b_tdata(63 downto 26) => (other => "0"),
      s_axis_b_tdata(25 downto 0)  => cosine(25 downto 0),
      m_axis_dout_tvalid           => open,
      m_axis_dout_tdata            => I_temp
      );

  I_out <= I_temp(25 downto 0);

  cmp_Q_mult : multiplier_s32_s26_s24
    port map(
      aclk                         => clk,
      s_axis_a_tvalid              => "1",
      s_axis_a_tdata(63 downto 32) => (others => "0"),
      s_axis_a_tdata(31 downto 0)  => input,
      s_axis_b_tvalid              => "1",
      s_axis_b_tdata(63 downto 26) => (other => "0"),
      s_axis_b_tdata(25 downto 0)  => sine(25 downto 0),
      m_axis_dout_tvalid           => open,
      m_axis_dout_tdata            => Q_temp
      );

  Q_out <= Q_temp(25 downto 0);

end rtl;
